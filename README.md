# metaseg GUI
GUI for evaluating and editing metaseg labels from ecSeg (https://github.com/UCRajkumar/ecSeg) output. Updates the labels and ec_quantification.csv file produced by ecSeg.

ecSeg publication:
Rajkumar, U. et al. ecSeg: Semantic Segmentation of Metaphase Images containing Extrachromosomal DNA. iScience. 21, 428-435. (2019)

## Example screenshot
![alt text](https://github.com/yanglum/metaseg_gui/blob/main/screenshot.png)

## Installation instructions
Using the Anaconda distribution of python is recommended. Compatible with ecseg environment.

Setting up the environment using the Anaconda prompt (no need if ecseg environment already installed):

1) 	conda create --name msgui python=3.9.2
2) 	pip install -r requirements.txt
  
Place metaseg_gui.py into the ecSeg directory (or the Example directory provided here) containing the config.yaml file and subdirectory containing the ecSeg inputs and outputs

# Change log
v14: no longer keeping track of pixel count. Switch to "draw polygon" if flip from/to listboxes are selected. Switch to "draw dot" if dot size is changed.

v13: clear borders of image (set to background). Minor tweaks.

v12: automatically load mask when opening image and not in "mass analysis" mode

v11: add option to draw disk on ecDNA mask to identify ecDNA

v10: automate identifying doublet ecDNA, allowing for user adjustment

v9: users can draw rectangle around doublet ecDNA (double minutes), which is kept track of 

v8: show chrDNA counts. Fixed bug with Continue checkbox. Fixed bug with Reset mask button

v7: QoL changes: hotkeys (tab to open image, enter to save mask), resize window upon start. Continue checkbox, if checked, now shows images without updated masks. Adjust current image and mask displays. Remove pixel pane (pixel count display)

v6: add button for marking image as inadequate (write "inadequate" to ec_quantification.csv)

v5: add true_background mask and add option to see original image (both dapi and stains)

v4: update ec_quantification csv file with updated counts from findContours when mask is saved

v3: count ecDNA using ecSeg generated mask and findContours, which updates as mask is updated

v2: reads the ec_quantification.csv file generated by ecseg and displays # of ec for the opened image

v1: saves mask with "updated_" prefix and when auto loading masks, looks for "updated_" masks first

# Helpful information

## Image acquisition
Open image: opens windows dialog box for selecting image to open, then opens another windows dialog box for selecting the mask (labels) file to open. If "Mass analysis" mode is checked, will open images (and corresponding masks) from "Image directory" (and "Mask directory") sequentially each time "Open image" is clicked. If there is an updated version of the mask (filename starts with "updated_"), it will be preferentially loaded. Also loads the original image file in the working directory; if subdirectory "Original" exists, will load the image file in that subdirectory with the closest name to the current image file.

Save mask: save the current mask to the "Mask directory" as a .png file with "updated_" at the beginning of the file name. This will also update the "ec_quantification.csv" file produced by ecSeg with a new column "updated #" displaying the updated ecDNA count (this overrides the "Mark inadequate" button). Also saves doublet counts and also update "ec_quantification.csv" with a new column "doublet #" displaying the doublet count. 

Mass analysis: check to enter mass analysis mode ("Open image" will open image files in "Image directory" sequentially).

Continue: if both "Mass analysis" and "Continue" are checked, "Open image" will open files in "Image directory" that do not have corresponding updated masks in "Mask directory".

Image directory: specify directory to image files for mass analysis mode.

Mask directory: specify directory to mask files for mass analysis mode.

## Show masks
Select masks (labels) to display from the mask file. The four labels from ecSeg ("background", "nuclei", "chromosome", "ecdna") are available. Additionally, user defined "doublets" and "true background" label is available as well, which are colored black. Allows for multiple selections at the same time.

Hide all: hide all masks.

Mark inadequate: labels this image as "inadequate" (i.e. inadequately labeled) in the "ec_quantification.csv" file, under column "updated #".

## Flip masks
Allows manual label adjustment of the mask file.

Flip from: select masks to be changed.

Flip to: select what to change to.

Polygon flip: click to draw and connect vertices of a polygon encirling the part of the mask image to flip. Double click to finish polygon.

Reset polygon: restart drawing polygon.

Undo: undo last change made to mask.

Reset mask: reset mask to original.

## Dot ecDNA
Allows manual identification of ecDNA.

Draw dot: draw a dot on the ecDNA mask.

Dot radius: radius of the dot, in pixels

## Identify doublets
Allows automatic and manual identification of doublet ecDNA by drawing a bounding box around the doublet.

Auto ID: auto identify doublet ecDNAs and draw a bounding box around them.

Draw box: click and drag to draw a box around a doublet. Release mouse to finish drawing box.

Undraw box: click inside a box to delete it.

Delete: delete all boxes.

## Hot keys
Tab: open image

Hold left shift: display dapi image

Hold control: display original image

Right shift: save mask

Left alt: draw box

Right alt: polygon flip
